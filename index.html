import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'elite-workout-v2';

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [clientName, setClientName] = useState('');
  const [workoutTitle, setWorkoutTitle] = useState('ADVANCED TRAINING PROGRAM');
  const [days, setDays] = useState([
    { 
      id: Date.now(), 
      name: 'DAY 01', 
      exercises: [{ id: 1, name: '', sets: '', reps: '', weight: '', rest: '', video: '', notes: '' }],
      cardio: { activity: '', duration: '', intensity: '' }
    }
  ]);
  const [showLinkModal, setShowLinkModal] = useState(false);
  const [generatedLink, setGeneratedLink] = useState('');

  // 1. Authentication (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Data Fetching & Real-time Sync (Rule 1 & 2)
  useEffect(() => {
    if (!user) return;

    const urlParams = new URLSearchParams(window.location.search);
    const workoutId = urlParams.get('id');

    if (workoutId) {
      // Path based on Rule 1: public data
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workouts', workoutId);
      
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          setClientName(data.clientName || '');
          setWorkoutTitle(data.workoutTitle || '');
          setDays(data.days || []);
        }
        setLoading(false);
      }, (error) => {
        console.error("Sync error:", error);
        setLoading(false);
      });

      return () => unsubscribe();
    } else {
      setLoading(false);
    }
  }, [user]);

  // 3. Save/Update Logic
  const saveWorkout = async () => {
    if (!user) return;
    setSaving(true);
    
    const urlParams = new URLSearchParams(window.location.search);
    let workoutId = urlParams.get('id');
    
    // Create a new ID if it doesn't exist
    if (!workoutId) {
      workoutId = 'workout-' + Math.random().toString(36).substr(2, 9);
    }

    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workouts', workoutId), {
        clientName,
        workoutTitle,
        days,
        updatedAt: new Date().toISOString(),
        updatedBy: user.uid
      });

      const baseUrl = window.location.href.split('?')[0];
      const finalLink = `${baseUrl}?id=${workoutId}`;
      setGeneratedLink(finalLink);
      setShowLinkModal(true);

      // Update URL without refreshing for the coach
      if (!urlParams.get('id')) {
        window.history.pushState({}, '', finalLink);
      }
    } catch (error) {
      console.error("Save error:", error);
    } finally {
      setSaving(false);
    }
  };

  const addDay = () => {
    setDays([...days, { 
      id: Date.now(), 
      name: `DAY ${String(days.length + 1).padStart(2, '0')}`, 
      exercises: [{ id: Date.now() + 1, name: '', sets: '', reps: '', weight: '', rest: '', video: '', notes: '' }],
      cardio: { activity: '', duration: '', intensity: '' }
    }]);
  };

  if (loading) return (
    <div className="min-h-screen bg-black flex flex-col items-center justify-center text-yellow-500 gap-4">
      <div className="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
      <p className="font-bold tracking-widest uppercase text-[10px]">Syncing Protocol...</p>
    </div>
  );

  return (
    <div className="min-h-screen pb-20 bg-slate-950 text-slate-100 font-sans selection:bg-yellow-500 selection:text-black" dir="ltr">
      
      {/* Link Modal */}
      {showLinkModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
          <div className="bg-slate-900 border border-yellow-500/30 p-8 rounded-[2rem] max-w-lg w-full shadow-2xl text-center">
            <h3 className="text-yellow-500 font-black text-2xl mb-2 italic uppercase">Program Live! üî•</h3>
            <p className="text-slate-400 text-sm mb-6 leading-relaxed">ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¢ŸÜ ŸÖÿ≠ŸÅŸàÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©. ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ Ÿàÿ£ÿ±ÿ≥ŸÑŸá ŸÑŸÑÿπŸÖŸäŸÑÿå ÿ£Ÿä ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸÑÿ£Ÿàÿ≤ÿßŸÜ ÿ≥Ÿäÿ∏Ÿáÿ± ÿπŸÜÿØŸÉ ŸÅŸàÿ±ÿßŸã.</p>
            <div className="bg-black/50 p-4 rounded-xl border border-white/5 mb-6 overflow-x-auto text-left">
              <code className="text-blue-400 text-xs">{generatedLink}</code>
            </div>
            <button 
              onClick={() => {
                const el = document.createElement('textarea');
                el.value = generatedLink;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                setShowLinkModal(false);
              }}
              className="w-full bg-yellow-500 text-black font-black py-4 rounded-xl hover:bg-yellow-400 transition-all uppercase text-sm tracking-widest"
            >
              Copy Link & Close
            </button>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="bg-slate-900 border-b border-white/5 pt-12 pb-24 px-6 relative overflow-hidden">
        <div className="absolute top-0 right-0 w-full h-full opacity-10 pointer-events-none">
          <div className="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] bg-yellow-500 rounded-full blur-[120px]"></div>
        </div>
        
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8 relative z-10">
          <div>
            <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-100 italic tracking-tighter uppercase leading-tight">
              ELITE TRACKER
            </h1>
            <p className="text-yellow-500/60 font-bold tracking-[0.4em] mt-2 text-[10px] uppercase">Coach & Client Live Protocol</p>
          </div>
          
          <div className="flex gap-3">
            <button 
              onClick={saveWorkout}
              disabled={saving}
              className="bg-yellow-500 hover:bg-yellow-400 text-black px-10 py-4 rounded-full font-black transition-all transform hover:scale-105 shadow-[0_0_30px_rgba(251,191,36,0.2)]"
            >
              {saving ? 'SYNCING...' : 'SAVE & UPDATE'}
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-4 md:p-10 -mt-16 relative z-20">
        {/* Identity Section */}
        <div className="bg-slate-900/80 backdrop-blur-2xl border border-white/10 rounded-[2.5rem] p-10 mb-10 shadow-2xl">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div className="border-l-2 border-yellow-500/30 pl-6">
              <label className="text-yellow-500 text-[10px] font-black uppercase tracking-[0.3em] mb-3 block opacity-70">Client Name</label>
              <input 
                className="bg-transparent w-full text-2xl font-black outline-none border-none placeholder-slate-800 focus:text-white"
                placeholder="Client Name..."
                value={clientName}
                onChange={(e) => setClientName(e.target.value)}
              />
            </div>
            <div>
              <label className="text-yellow-500 text-[10px] font-black uppercase tracking-[0.3em] mb-3 block opacity-70">Program Goal</label>
              <input 
                className="bg-transparent w-full text-2xl font-black outline-none border-none placeholder-slate-800 focus:text-white"
                placeholder="e.g. Mass Gainer..."
                value={workoutTitle}
                onChange={(e) => setWorkoutTitle(e.target.value)}
              />
            </div>
          </div>
        </div>

        {/* Days List */}
        <div className="space-y-20">
          {days.map((day, dIdx) => (
            <section key={day.id} className="relative">
              <div className="flex items-center gap-4 mb-8 px-6">
                <div className="h-10 w-2 bg-yellow-500 rounded-full"></div>
                <input 
                  className="bg-transparent text-4xl font-black text-white outline-none focus:text-yellow-400 w-full uppercase italic tracking-tighter"
                  value={day.name}
                  onChange={(e) => {
                    const newDays = [...days];
                    newDays[dIdx].name = e.target.value;
                    setDays(newDays);
                  }}
                />
              </div>

              {/* Exercises Table */}
              <div className="bg-slate-900 border border-white/5 rounded-[2.5rem] overflow-hidden shadow-2xl mb-6">
                <div className="overflow-x-auto">
                  <table className="w-full text-left border-collapse">
                    <thead>
                      <tr className="bg-white/5 text-yellow-500/50 text-[10px] font-black uppercase tracking-widest">
                        <th className="p-6">EXERCISE</th>
                        <th className="p-6 text-center">SETS</th>
                        <th className="p-6 text-center">REPS</th>
                        <th className="p-6 text-center bg-yellow-500/10 text-yellow-500 italic">CLIENT LOAD (KG)</th>
                        <th className="p-6 text-center">REST</th>
                        <th className="p-6">TUTORIAL / NOTES</th>
                        <th className="p-6 w-12"></th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-white/5">
                      {day.exercises.map((ex, eIdx) => (
                        <tr key={ex.id} className="hover:bg-white/[0.02] transition-colors">
                          <td className="p-6 min-w-[200px]">
                            <input 
                              className="bg-transparent w-full font-bold outline-none placeholder-slate-700" 
                              placeholder="Exercise Name" 
                              value={ex.name} 
                              onChange={(e) => {
                                const newDays = [...days];
                                newDays[dIdx].exercises[eIdx].name = e.target.value;
                                setDays(newDays);
                              }} 
                            />
                          </td>
                          <td className="p-6 w-20">
                            <input className="bg-transparent w-full text-center font-black outline-none" value={ex.sets} placeholder="0" onChange={(e) => {
                               const newDays = [...days];
                               newDays[dIdx].exercises[eIdx].sets = e.target.value;
                               setDays(newDays);
                            }} />
                          </td>
                          <td className="p-6 w-20">
                            <input className="bg-transparent w-full text-center font-black outline-none" value={ex.reps} placeholder="0" onChange={(e) => {
                               const newDays = [...days];
                               newDays[dIdx].exercises[eIdx].reps = e.target.value;
                               setDays(newDays);
                            }} />
                          </td>
                          <td className="p-6 w-32 bg-yellow-500/5">
                            <input 
                              className="bg-transparent w-full text-center font-black text-yellow-500 outline-none placeholder-yellow-900/30" 
                              value={ex.weight} 
                              placeholder="0.0" 
                              onChange={(e) => {
                               const newDays = [...days];
                               newDays[dIdx].exercises[eIdx].weight = e.target.value;
                               setDays(newDays);
                            }} />
                          </td>
                          <td className="p-6 w-24 text-center">
                            <input className="bg-transparent w-full text-center font-bold text-slate-500 outline-none text-xs" value={ex.rest} placeholder="60s" onChange={(e) => {
                               const newDays = [...days];
                               newDays[dIdx].exercises[eIdx].rest = e.target.value;
                               setDays(newDays);
                            }} />
                          </td>
                          <td className="p-6 min-w-[150px]">
                            <input className="bg-transparent w-full text-[10px] text-blue-400 outline-none" placeholder="Video link or Coach notes..." value={ex.video} onChange={(e) => {
                               const newDays = [...days];
                               newDays[dIdx].exercises[eIdx].video = e.target.value;
                               setDays(newDays);
                            }} />
                          </td>
                          <td className="p-6 text-center">
                            <button onClick={() => {
                              const newDays = [...days];
                              newDays[dIdx].exercises = newDays[dIdx].exercises.filter((_, i) => i !== eIdx);
                              setDays(newDays);
                            }} className="opacity-20 hover:opacity-100 text-red-500">‚úï</button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                
                <button 
                  onClick={() => {
                    const newDays = [...days];
                    newDays[dIdx].exercises.push({ id: Date.now(), name: '', sets: '', reps: '', weight: '', rest: '', video: '', notes: '' });
                    setDays(newDays);
                  }}
                  className="w-full py-5 text-[10px] font-black text-slate-500 hover:text-yellow-500 transition-all uppercase tracking-widest border-t border-white/5 bg-white/[0.01]"
                >
                  + Add Exercise
                </button>
              </div>

              {/* Cardio Section */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-slate-900 border border-white/5 rounded-2xl p-4 flex flex-col gap-2">
                  <span className="text-[10px] font-black text-yellow-500/50 uppercase tracking-widest">Cardio Activity</span>
                  <input 
                    className="bg-transparent font-bold text-white outline-none placeholder-slate-700"
                    placeholder="e.g. Incline Walk"
                    value={day.cardio?.activity || ''}
                    onChange={(e) => {
                      const newDays = [...days];
                      if (!newDays[dIdx].cardio) newDays[dIdx].cardio = {};
                      newDays[dIdx].cardio.activity = e.target.value;
                      setDays(newDays);
                    }}
                  />
                </div>
                <div className="bg-slate-900 border border-white/5 rounded-2xl p-4 flex flex-col gap-2">
                  <span className="text-[10px] font-black text-yellow-500/50 uppercase tracking-widest">Duration</span>
                  <input 
                    className="bg-transparent font-bold text-white outline-none placeholder-slate-700"
                    placeholder="e.g. 20 mins"
                    value={day.cardio?.duration || ''}
                    onChange={(e) => {
                      const newDays = [...days];
                      if (!newDays[dIdx].cardio) newDays[dIdx].cardio = {};
                      newDays[dIdx].cardio.duration = e.target.value;
                      setDays(newDays);
                    }}
                  />
                </div>
                <div className="bg-slate-900 border border-white/5 rounded-2xl p-4 flex flex-col gap-2">
                  <span className="text-[10px] font-black text-yellow-500/50 uppercase tracking-widest">Intensity</span>
                  <input 
                    className="bg-transparent font-bold text-white outline-none placeholder-slate-700"
                    placeholder="e.g. Moderate"
                    value={day.cardio?.intensity || ''}
                    onChange={(e) => {
                      const newDays = [...days];
                      if (!newDays[dIdx].cardio) newDays[dIdx].cardio = {};
                      newDays[dIdx].cardio.intensity = e.target.value;
                      setDays(newDays);
                    }}
                  />
                </div>
              </div>
            </section>
          ))}
        </div>

        <button 
          onClick={addDay}
          className="w-full py-16 border-2 border-dashed border-white/5 rounded-[3rem] mt-12 text-slate-800 font-black text-xl hover:border-yellow-500/30 hover:text-yellow-500/30 hover:bg-yellow-500/[0.02] transition-all uppercase italic tracking-widest"
        >
          Add Training Protocol Day
        </button>
      </main>

      {/* Persistence Note */}
      <footer className="max-w-7xl mx-auto px-10 pt-10 text-slate-600 text-[10px] uppercase font-bold tracking-widest text-center">
        Cloud Sync Enabled ‚Ä¢ Data persists on the cloud for real-time coaching.
      </footer>
    </div>
  );